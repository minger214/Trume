<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trume - Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="css/shared.css" rel="stylesheet">
    <script src="js/shared.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#090A0A',
                        darkSecondary: '#191919',
                        white: '#FFFFFF',
                        white98: '#FAFAFA',
                        white50: '#808080',
                        primary: '#8247E5',
                        secondary: '#D434FE',
                        accent: '#FF2E93',
                        grayDark: '#28282B',
                    },
                    fontFamily: {
                        'sf-pro': ['SF Pro', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .recent-project-item {
                transition: all 0.3s ease;
            }
            .recent-project-item:hover {
                transform: scale(1.03);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }
            .recent-project-item:active {
                transform: scale(0.95);
            }
            .app-logo {
                background: linear-gradient(135deg, #8247E5, #D434FE);
            }
            .backdrop-blur {
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
            }
            .toast-message {
                background-color: rgba(25, 25, 25, 0.9);
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
                border-radius: 9999px;
                padding: 0.75rem 1.25rem;
                color: white;
                position: fixed;
                left: 50%;
                transform: translateX(-50%);
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideUp 0.3s ease-out;
            }
            .bottom-nav-active {
                color: white;
            }
            .bottom-nav-active .nav-icon {
                background-color: rgba(255, 255, 255, 0.1);
            }
        }
        /* iOS Screen styles moved to shared.css */
    </style>
</head>
<body class="bg-dark font-sf-pro text-white min-h-screen">
      <!-- iOS Device Container -->
      <div class="ios-screen mx-auto bg-dark">
        <!-- iOS Status Bar -->
        <div class="h-7 bg-dark z-50 flex items-center justify-between px-4">
            <div class="text-xs text-white font-medium">9:41</div>
            <div class="flex items-center space-x-2 text-white">
                <i class="fa fa-signal"></i>
                <i class="fa fa-wifi"></i>
                <i class="fa fa-battery-full"></i>
            </div>
        </div>
        
        <!-- iOS Navigation Bar -->
        <div class="flex items-center px-4 py-3 border-b border-white/10 animate-fade-in">
            <div class="flex items-center flex-1">
                <button id="credits-button" class="w-10 h-10 app-logo rounded-full flex items-center justify-center shadow-lg shadow-primary/20 nav-button">
                    <i class="fa fa-money text-white text-lg"></i>
                </button>
            </div>
            <div class="text-center flex-1">
                <h1 class="text-white font-semibold text-lg">Trume</h1>
            </div>
            <div class="flex items-center justify-end space-x-4 flex-1">
                <button id="notification-button" class="text-white p-2 rounded-full active:bg-white/10 transition-colors nav-button">
                    <i class="fa fa-bell-o"></i>
                </button>
                <button id="settings-button" class="text-white p-2 rounded-full active:bg-white/10 transition-colors nav-button">
                    <i class="fa fa-cog"></i>
                </button>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto h-[calc(100%-6.5rem)] scrollbar-hide pb-6">
            <!-- Featured Illustration -->
            <div class="mt-2 px-4">
                <div id="featured-section" class="rounded-2xl overflow-hidden shadow-md shadow-black/30 animate-fade-in">
                    <div class="p-4 bg-darkSecondary">
                        <h2 class="text-white text-xl font-semibold">Show us what you look like</h2>
                        <p class="text-white50 text-sm">Upload your selfies to help the AI generate realistic portrait photos of you! </p>
                    </div>
                    <img src="images/home-introduce.png" alt="AI Photo Generation" class="w-full h-auto object-contain max-h-[24rem]">
                </div>
            </div>
            
            <!-- Selected Photos Display -->
            <div id="selected-photos-container" class="px-4 mt-3 mb-2">
                <h3 class="text-white font-medium mb-3">Your selfies</h3>
                <div id="selected-photos-grid" class="grid grid-cols-4 gap-3">
                    <!-- Selected photos will be inserted here -->
                </div>
            </div>

            <!-- Upload Button -->
            <div class="px-4 mt-4">
                <button id="upload-photos-button" class="w-full py-4 bg-gradient-to-r from-primary to-secondary rounded-xl text-white font-semibold text-lg shadow-md transition-all duration-300 active:opacity-90 active:scale-98">
                    Upload photos
                </button>
            </div>
            
            <!-- Photo Source Selection Modal (hidden by default) -->
            <div id="photo-source-modal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center">
                <div class="bg-darkSecondary rounded-2xl w-[90%] max-w-xs transform transition-transform duration-300 translate-y-full">
                    <!-- Header with close button -->
                    <div class="relative px-5 pt-5 pb-2">
                        <h3 class="text-white text-lg font-semibold text-center">Take photo from</h3>
                        <button id="close-modal" class="absolute top-5 right-5 w-8 h-8 flex items-center justify-center rounded-full bg-darkSecondary hover:bg-dark transition-colors duration-200">
                            <span class="text-white text-lg">✕</span>
                        </button>
                    </div>
                    <!-- Options -->
                    <div class="px-5 pb-5 space-y-3">
                        <button id="camera-option" class="w-full py-3.5 bg-darkSecondary rounded-xl text-white font-medium flex items-center justify-center gap-3">
                            <i class="fa fa-camera text-lg"></i>
                            <span>Camera</span>
                        </button>
                        <button id="library-option" class="w-full py-3.5 bg-darkSecondary rounded-xl text-white font-medium flex items-center justify-center gap-3">
                            <i class="fa fa-picture-o text-lg"></i>
                            <span>Photo library</span>
                        </button>
                    </div>
                </div>
            </div>
            

        </div>
        

    </div>
    
    <!-- Toast Container -->
      <div id="toast-container" class="fixed inset-0 pointer-events-none flex items-center justify-center z-50"></div>

    <script>
        // 共享函数已通过window对象挂载，无需导入
        
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化共享功能
            window.initializeSharedFunctions();
            
            // 显示欢迎消息
            window.showToast('Welcome back to Trume!', 'info');
            
            // Only initialize existing elements
            const notificationButton = document.getElementById('notification-button');
            const settingsButton = document.getElementById('settings-button');
            const featuredSection = document.getElementById('featured-section');
            
            if (notificationButton) {
                notificationButton.addEventListener('click', function() {
                    window.buttonClickAnimation(notificationButton, function() {
                        window.showToast('No new notifications');
                    });
                });
            }
            
            if (settingsButton) {
                settingsButton.addEventListener('click', function() {
                    window.buttonClickAnimation(settingsButton, function() {
                        window.showToast('Settings coming soon');
                    });
                });
            }
            
            if (featuredSection) {
                featuredSection.addEventListener('click', function() {
                    window.buttonClickAnimation(featuredSection, function() {
                        window.navigateTo('template.html', 0);
                    });
                });
            }
            
            // Upload photos button and modal functionality
            const uploadPhotosButton = document.getElementById('upload-photos-button');
            const photoSourceModal = document.getElementById('photo-source-modal');
            
            // 初始化模态框管理器
            let photoModal = null;
            if (photoSourceModal) {
                photoModal = new ModalManager('photo-source-modal');
            }
            
            const cameraOption = document.getElementById('camera-option');
            const libraryOption = document.getElementById('library-option');
            const closeModalButton = document.getElementById('close-modal');
            const selectedPhotosContainer = document.getElementById('selected-photos-container');
            const selectedPhotosGrid = document.getElementById('selected-photos-grid');
            
            // Function to display selected photos on home page
            function displaySelectedPhotos() {
                // Get selected photos from localStorage
                const selectedPhotos = window.getStorageItem('selectedPhotos', []);
                
                if (selectedPhotos.length > 0) {
                    // Show the selected photos container
                    selectedPhotosContainer.classList.remove('hidden');
                    
                    // Clear existing photos
                    selectedPhotosGrid.innerHTML = '';
                    
                    // Add photos to the grid
                    selectedPhotos.forEach((photo, index) => {
                        const photoItem = document.createElement('div');
                        photoItem.className = 'aspect-square rounded-lg overflow-hidden relative';
                        
                        // Add photo image
                        const img = document.createElement('img');
                        img.src = photo.src;
                        img.alt = photo.alt || `Selected photo ${index + 1}`;
                        img.className = 'w-full h-full object-cover';
                        
                        // Add selection number indicator
                        const indicator = document.createElement('div');
                        indicator.className = 'absolute bottom-1 right-1 w-5 h-5 rounded-full bg-[#007AFF] flex items-center justify-center text-white text-xs font-medium';
                        indicator.textContent = (index + 1).toString();
                        
                        // Add delete button
                        const deleteButton = document.createElement('div');
                        deleteButton.className = 'absolute top-1 right-1 w-5 h-5 rounded-full bg-black/50 flex items-center justify-center text-white text-xs cursor-pointer active:bg-black/70 transition-all duration-200 z-10 opacity-0';
                        deleteButton.textContent = '✕';
                        
                        // Show delete button on hover
                        photoItem.addEventListener('mouseenter', function() {
                            deleteButton.classList.add('opacity-100');
                        });
                        
                        // Hide delete button when not hovering
                        photoItem.addEventListener('mouseleave', function() {
                            deleteButton.classList.remove('opacity-100');
                        });
                        
                        // Add click event for delete button
                        deleteButton.addEventListener('click', function(e) {
                            e.stopPropagation(); // Prevent triggering other events
                            
                            // Create animation for deletion
                            photoItem.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                            photoItem.style.transform = 'scale(0)';
                            photoItem.style.opacity = '0';
                            
                            // Remove the photo from localStorage after animation
                            setTimeout(() => {
                                // Get updated list of photos without the deleted one
                                const updatedPhotos = selectedPhotos.filter((_, i) => i !== index);
                                
                                // Update localStorage
                                window.setStorageItem('selectedPhotos', updatedPhotos);
                                
                                // Show toast message
                                window.showToast('Photo removed', 'fa-trash-alt', 1000);
                                
                                // If no photos left, hide the container
                                if (updatedPhotos.length === 0) {
                                    selectedPhotosContainer.classList.add('hidden');
                                    uploadPhotosButton.textContent = 'Upload photos';
                                } else {
                                    // Re-display the photos to update indices
                                    displaySelectedPhotos();
                                }
                            }, 300);
                        });
                        
                        photoItem.appendChild(img);
                        photoItem.appendChild(indicator);
                        photoItem.appendChild(deleteButton);
                        selectedPhotosGrid.appendChild(photoItem);
                    });
                    
                    // Add "+" button at the end of the grid to allow adding more photos
                    const addPhotoButton = document.createElement('div');
                    addPhotoButton.className = 'aspect-square rounded-lg overflow-hidden relative bg-darkSecondary flex items-center justify-center cursor-pointer active:bg-darkSecondary/80 transition-colors duration-200 border-2 border-dashed border-white/20';
                    
                    const plusIcon = document.createElement('i');
                    plusIcon.className = 'fa fa-plus text-white/70 text-2xl';
                    
                    addPhotoButton.appendChild(plusIcon);
                    selectedPhotosGrid.appendChild(addPhotoButton);
                    
                    // Add click event to navigate to select-photo.html
                    addPhotoButton.addEventListener('click', function() {
                        window.buttonClickAnimation(this, function() {
                            window.navigateTo('select-photo.html', 150);
                        });
                    });
                    
                    // Change button text to "Continue"
                    uploadPhotosButton.textContent = 'Continue';
                }
            }
            
            // Check if subscription has expired
            function checkSubscriptionStatus() {
                try {
                    let userData = window.getStorageItem('userData', {
                        isPremiumMember: false,
                        subscriptionEndDate: null,
                        rechargeCredits: 0,
                        totalCredits: 0,
                        credits: 0,
                        subscriptionCredits: 0
                    });
                
                    // If user is premium member and has a subscription end date
                    if (userData.isPremiumMember && userData.subscriptionEndDate) {
                        const now = new Date();
                        const endDate = new Date(userData.subscriptionEndDate);
                        
                        // If subscription has expired
                        if (now > endDate) {
                            // Update user status
                            userData.isPremiumMember = false;
                            userData.subscriptionCredits = 0;
                            userData.totalCredits = userData.rechargeCredits || 0;
                            userData.credits = userData.totalCredits; // Keep backward compatibility
                            
                            // Save updated data
                            window.setStorageItem('userData', userData);
                            
                            // Show expiration notification
                            window.showToast('Your subscription has expired. Please renew to continue enjoying premium features.', 'error', 5000);
                        } else {
                            // Calculate days remaining
                            const daysRemaining = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                            
                            // Show reminder if subscription is about to expire (e.g., in 2 days or less)
                            if (daysRemaining <= 2 && daysRemaining > 0) {
                                window.showToast(`Your subscription expires in ${daysRemaining} ${daysRemaining === 1 ? 'day' : 'days'}.`, 'warning', 5000);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking subscription status:', error);
                }
            }
            
            // Set mock data for demonstration
            function setMockData() {
                // Check if localStorage already has data
                if (!window.getStorageItem('selectedPhotos')) {
                    // For demo purposes, let's set some mock selected photos
                    const mockPhotos = [
                        { index: 0, src: 'https://picsum.photos/400/400?random=1', alt: 'Sample photo 1' },
                        { index: 1, src: 'https://picsum.photos/400/400?random=2', alt: 'Sample photo 2' },
                        { index: 2, src: 'https://picsum.photos/400/400?random=3', alt: 'Sample photo 3' },
                        { index: 3, src: 'https://picsum.photos/400/400?random=4', alt: 'Sample photo 4' },
                        { index: 4, src: 'https://picsum.photos/400/400?random=5', alt: 'Sample photo 5' }
                    ];
                    window.setStorageItem('selectedPhotos', mockPhotos);
                }
                
                // Initialize user data if not exists (using userData object for consistency)
                let userData = window.getStorageItem('userData');
                if (!userData) {
                    userData = {
                        isPremiumMember: true,
                        credits: 500,
                        subscriptionCredits: 500,
                        rechargeCredits: 0,
                        totalCredits: 500,
                        usedCredits: 0,
                        subscriptionEndDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                        transactionHistory: []
                    };
                    window.setStorageItem('userData', userData);
                }
            }
            
            // Set mock data and display selected photos when page loads
            setMockData();
            checkSubscriptionStatus();
            displaySelectedPhotos();
            
            if (uploadPhotosButton && photoSourceModal) {
                uploadPhotosButton.addEventListener('click', function() {
                    const selectedPhotos = window.getStorageItem('selectedPhotos', []);
                    
                    // Check if button text is 'Continue'
                    if (uploadPhotosButton.textContent.trim() === 'Continue') {
                        // If button says 'Continue', proceed based on user status
                        window.buttonClickAnimation(uploadPhotosButton, function() {
                            // Check if user is premium member and has enough credits
                            let userData = window.getStorageItem('userData', {isPremiumMember: false, credits: 0});
                            const isPremiumMember = userData.isPremiumMember;
                            const userCredits = userData.credits || 0;
                            // Each project costs 25 credits, generating 6 projects requires 150 credits
                            const requiredCredits = 150;
                              
                            window.showToast('Processing...');
                            
                            // Navigate to appropriate page based on user status
                            setTimeout(() => {
                                if (!isPremiumMember) {
                                    // Non-premium member: go to subscription page
                                    window.navigateTo('subscription.html', 0);
                                } else if (userCredits < requiredCredits) {
                                    // Premium member but insufficient credits: show warning toast first
                                    window.showToast('Insufficient credits! You need 150 credits to generate 6 projects.');
                                    setTimeout(() => {
                                        window.navigateTo('credit-purchase.html', 0);
                                    }, 1500);
                                } else {
                                    // Premium member with sufficient credits: deduct credits and go to portfolio generating page
                                    // Deduct credits with priority: use subscription credits first, then recharge credits
                                    let remainingCreditsNeeded = requiredCredits;
                                    
                                    // Deduct from subscription credits first
                                    if (userData.subscriptionCredits > 0) {
                                        const deductionFromSubscription = Math.min(userData.subscriptionCredits, remainingCreditsNeeded);
                                        userData.subscriptionCredits -= deductionFromSubscription;
                                        remainingCreditsNeeded -= deductionFromSubscription;
                                    }
                                    
                                    // Deduct from recharge credits if needed
                                    if (remainingCreditsNeeded > 0 && userData.rechargeCredits > 0) {
                                        userData.rechargeCredits -= remainingCreditsNeeded;
                                        remainingCreditsNeeded = 0;
                                    }
                                    
                                    // Update total credits
                                    userData.totalCredits = userData.subscriptionCredits + userData.rechargeCredits;
                                    userData.credits = userData.totalCredits; // Keep backward compatibility
                                    userData.usedCredits = (userData.usedCredits || 0) + requiredCredits;
                                    
                                    // Add transaction record
                                    if (!userData.transactionHistory) {
                                        userData.transactionHistory = [];
                                    }
                                    userData.transactionHistory.push({
                                        type: 'usage',
                                        description: 'Project Generation',
                                        amount: requiredCredits,
                                        date: new Date().toISOString(),
                                        creditsChange: -requiredCredits,
                                        subscriptionEndDate: userData.subscriptionEndDate
                                    });
                                    
                                    // Save updated data
                                    window.setStorageItem('userData', userData);
                                    window.showToast(`150 credits deducted. Remaining credits: ${userData.credits}`, 'success');
                                    
                                    // Set flag in localStorage to generate new projects
                                    window.setStorageItem('generateNewProjects', 'true');
                                    window.navigateTo('portfolio-generating.html', 0);
                                }
                            }, 1000);
                        });
                    } else {
                        // 使用ModalManager打开照片源选择模态框
                        window.buttonClickAnimation(uploadPhotosButton, function() {
                            if (photoModal) {
                                photoModal.open();
                            }
                        });
                    }
                });
                
                if (closeModalButton) {
                    closeModalButton.addEventListener('click', function() {
                        window.buttonClickAnimation(closeModalButton, function() {
                            if (photoModal) {
                                photoModal.close();
                            }
                        });
                    });
                }
                
                if (cameraOption) {
                        cameraOption.addEventListener('click', function() {
                            window.buttonClickAnimation(cameraOption, function() {
                                if (photoModal) {
                                    photoModal.close();
                                }
                                window.showToast('Camera option selected', 'fa-camera', 2000);
                                // 导航到相机页面
                                window.navigateTo('camera.html', 0);
                            });
                        });
                    }
                    
                    if (libraryOption) {
                        libraryOption.addEventListener('click', function() {
                            window.buttonClickAnimation(libraryOption, function() {
                                if (photoModal) {
                                    photoModal.close();
                                }
                                window.showToast('Photo library option selected', 'fa-image', 2000);
                                // 导航到照片选择页面
                                window.navigateTo('select-photo.html', 0);
                            });
                        });
                    }
                    
                    // 添加积分按钮点击事件
                    const creditsButton = document.getElementById('credits-button');
                    if (creditsButton) {
                        creditsButton.addEventListener('click', function() {
                            window.buttonClickAnimation(creditsButton, function() {
                                window.navigateTo('user-credits.html', 0);
                            });
                        });
                    }
            }
        });
    </script>
    

</body>
</html>